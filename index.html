<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Controle de Estacionamento</title>
<style>
  :root{
    --prim:#0066cc; --prim-2:#00bfff; --bg1:linear-gradient(135deg,#4A90E2,#003366);
  }
  *{box-sizing:border-box}
  body{
    font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
    background: var(--bg1);
    color:#fff;
    margin:0; padding:18px;
    display:flex; align-items:center; justify-content:center; min-height:100vh;
  }
  main{
    width:100%; max-width:920px; background:#fff0; border-radius:12px; padding:18px;
  }
  header{ text-align:center; margin-bottom:12px }
  h1{ margin:0; color:var(--prim); font-size:1.6rem }
  p.lead{ color:#eaf2ff; margin:6px 0 14px; font-size:0.95rem }

  .container{
    display:grid; grid-template-columns: 1fr 360px; gap:16px;
  }

  /* left column: forms */
  .card{
    background: rgba(255,255,255,0.07);
    border-radius:10px; padding:14px; box-shadow:0 6px 18px rgba(0,0,0,0.12);
  }

  .tabs{ display:flex; gap:8px; justify-content:center; margin-bottom:12px }
  .tab{
    padding:8px 14px; border-radius:8px 8px 0 0; background:var(--prim); cursor:pointer; font-weight:700;
  }
  .tab.active{ background:var(--prim-2); color:#003 }

  .tab-content{ display:none }
  .tab-content.active{ display:block }

  label{ display:block; margin:8px 0 6px; font-weight:700; color:#eaf2ff }
  input[type="text"], select, input[type="file"]{
    width:100%; padding:10px; border-radius:8px; border:none; font-size:0.95rem;
  }
  .btn{ background:var(--prim-2); color:#003; padding:10px; border-radius:8px; border:none; font-weight:700; cursor:pointer; width:100% }
  .btn.secondary{ background:#ccc; color:#123; }

  .resultado{ margin-top:10px; color:#e8f4ff; font-size:0.95rem }
  .foto img{ max-width:100%; border-radius:8px; margin-top:8px }

  /* right column: pesquisa + logs */
  .side { display:flex; flex-direction:column; gap:12px; }
  .box { background: rgba(255,255,255,0.06); padding:12px; border-radius:10px; }

  .small{ font-size:0.85rem; color:#dfefff }

  table{ width:100%; border-collapse:collapse; font-size:0.9rem; color:#002 }
  th,td{ padding:8px; border-bottom:1px solid rgba(0,0,0,0.06); background:#fff; }
  th{ background:#f0f8ff; font-weight:700 }

  @media (max-width:900px){
    .container{ grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<main>
  <header>
    <h1>Controle de Estacionamento</h1>
    <p class="lead">Entrada / Saída / Pesquisa — placas por texto ou foto (opcional). Funciona no GitHub Pages.</p>
  </header>

  <div class="container">
    <div>
      <div class="card">
        <div class="tabs">
          <div class="tab active" data-target="entrada" onclick="abrirAba('entrada', this)">Entrada</div>
          <div class="tab" data-target="saida" onclick="abrirAba('saida', this)">Saída</div>
          <div class="tab" data-target="pesquisa" onclick="abrirAba('pesquisa', this)">Pesquisa</div>
        </div>

        <!-- Entrada -->
        <div id="entrada" class="tab-content active">
          <label for="placaEntrada">Placa do veículo (texto) — ou deixe em branco e use foto</label>
          <input id="placaEntrada" type="text" placeholder="ABC1D23">

          <label for="tipoEntrada">Tipo de entrada</label>
          <select id="tipoEntrada">
            <option>Sem Parar</option>
            <option>Veloe</option>
            <option>ConectCar</option>
            <option>Hotel</option>
            <option>Avulso</option>
          </select>

          <label for="fotoEntrada">Foto da placa (opcional)</label>
          <input id="fotoEntrada" type="file" accept="image/*" capture="environment">

          <div style="margin-top:8px">
            <button class="btn" id="btnEntrada">Registrar Entrada</button>
          </div>

          <div class="resultado" id="resEntrada"></div>
        </div>

        <!-- Saída -->
        <div id="saida" class="tab-content">
          <label for="placaSaida">Placa do veículo (texto) — ou deixe em branco e use foto</label>
          <input id="placaSaida" type="text" placeholder="ABC1D23">

          <label for="fotoSaida">Foto da placa na saída (opcional)</label>
          <input id="fotoSaida" type="file" accept="image/*" capture="environment">

          <div style="margin-top:8px">
            <button class="btn" id="btnSaida">Registrar Saída</button>
          </div>

          <div class="resultado" id="resSaida"></div>
        </div>

        <!-- Pesquisa -->
        <div id="pesquisa" class="tab-content">
          <label for="placaBusca">Pesquisar por placa</label>
          <input id="placaBusca" type="text" placeholder="Digite a placa...">
          <div style="margin-top:8px">
            <button class="btn" id="btnBusca">Pesquisar</button>
          </div>
          <div class="resultado" id="resBusca"></div>
        </div>
      </div>
    </div>

    <!-- right side -->
    <aside class="side">
      <div class="box">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Últimos registros</strong>
          <button class="btn secondary" id="btnRefresh" style="width:auto">Atualizar</button>
        </div>
        <div id="listaRegistros" style="margin-top:8px" class="small">Carregando…</div>
      </div>

      <div class="box small">
        <div><b>Dicas</b></div>
        <ul>
          <li>Se quiser que celulares e PC compartilhem dados, use o Firebase (já configurado).</li>
          <li>Fotos são opcionais — o sistema funciona com texto da placa também.</li>
          <li>Se houver múltiplas entradas da mesma placa, a pesquisa mostra o registro mais recente.</li>
        </ul>
      </div>
    </aside>
  </div>
</main>

<!-- Firebase compat SDKs (sem imports ES modules) -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics-compat.js"></script>

<script>
/* ============================
   Configuração Firebase (seu projeto)
   ============================ */
const firebaseConfig = {
  apiKey: "AIzaSyALUYbhc6OeauTBNL2K7EkKW2So706HZdU",
  authDomain: "teste-estac.firebaseapp.com",
  projectId: "teste-estac",
  storageBucket: "teste-estac.firebasestorage.app",
  messagingSenderId: "266651221931",
  appId: "1:266651221931:web:e43dd1e4687a1da9361cee",
  measurementId: "G-07Y4BKG0TM"
};

firebase.initializeApp(firebaseConfig);
try { firebase.analytics(); } catch(e){ /* analytics opcional */ }
const db = firebase.firestore();
const storage = firebase.storage();

/* ============================
   Helpers
   ============================ */
function qs(id){ return document.getElementById(id); }
function formatLocal(iso){ try { return new Date(iso).toLocaleString(); } catch(e){ return iso; } }
function calcularTempo(entradaISO, saidaISO){
  const diffMs = new Date(saidaISO) - new Date(entradaISO);
  if(isNaN(diffMs) || diffMs < 0) return null;
  const totalMin = Math.floor(diffMs / 60000);
  const h = Math.floor(totalMin / 60);
  const m = totalMin % 60;
  return `${h}h ${m}m`;
}

/* ============================
   Abas
   ============================ */
function abrirAba(nome, el){
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  qs(nome).classList.add('active');
  if(el) el.classList.add('active');
  qs('resEntrada').innerHTML=''; qs('resSaida').innerHTML=''; qs('resBusca').innerHTML='';
}

/* ============================
   Entradas / Saídas / Pesquisa
   ============================ */

// Carrega últimos registros (lista rápida)
async function carregarUltimos(){
  const lista = qs('listaRegistros');
  lista.innerHTML = 'Carregando...';
  try{
    const snap = await db.collection('registros').orderBy('horarioEntrada','desc').limit(10).get();
    if(snap.empty){ lista.innerHTML = '<i>Nenhum registro</i>'; return; }
    const rows = [];
    snap.forEach(d => {
      const r = d.data();
      rows.push(`<div style="padding:6px 0;border-bottom:1px solid rgba(0,0,0,0.06);background:#fff;margin-top:6px;border-radius:6px;padding:8px">
        <div style="font-weight:700;color:#003">${r.placa || '—'}</div>
        <div style="font-size:0.85rem;color:#002">${r.tipo} • ${formatLocal(r.horarioEntrada)}</div>
        <div style="font-size:0.82rem;color:#444">${r.tempo ? 'Tempo: '+r.tempo : (r.saida? 'Tempo: '+r.tempo : 'No pátio')}</div>
      </div>`);
    });
    lista.innerHTML = rows.join('');
  }catch(err){
    console.error(err);
    lista.innerHTML = '<i>Erro ao carregar</i>';
  }
}

// Registrar entrada
qs('btnEntrada').addEventListener('click', async ()=>{
  const placaText = qs('placaEntrada').value.trim().toUpperCase();
  const tipo = qs('tipoEntrada').value || 'Avulso';
  const file = qs('fotoEntrada').files[0];
  const horarioEntrada = new Date().toISOString();

  // Se nem texto nem foto, não faz sentido
  if(!placaText && !file){
    return alert('Informe a placa (texto) ou envie uma foto.');
  }

  qs('resEntrada').innerHTML = 'Registrando…';

  try{
    let placaFinal = placaText || null;

    // Se tiver foto mas não placa, vamos tentar salvar sem placa (usuário corrige depois)
    let fotoURL = null;
    if(file){
      const nome = `fotos/${ (placaFinal || 'semplaca') }_${Date.now()}`;
      const ref = storage.ref().child(nome);
      await ref.put(file);
      fotoURL = await ref.getDownloadURL();
    }

    const registro = {
      placa: placaFinal,
      tipo,
      horarioEntrada,
      fotoEntrada: fotoURL || null,
      saida: null,
      fotoSaida: null,
      tempo: null
    };

    // adiciona documento com id automático (permite múltiplas entradas da mesma placa)
    await db.collection('registros').add(registro);

    qs('resEntrada').innerHTML = `<span style="color:#e8ffd8">Entrada registrada.</span>`;
    qs('placaEntrada').value = ''; qs('fotoEntrada').value = '';
    await carregarUltimos();
  }catch(err){
    console.error(err);
    alert('Erro ao registrar entrada: ' + (err.message||err));
    qs('resEntrada').innerHTML = '';
  }
});

// Registrar saída (procura registro aberto mais recente da placa)
qs('btnSaida').addEventListener('click', async ()=>{
  const placaText = qs('placaSaida').value.trim().toUpperCase();
  const file = qs('fotoSaida').files[0];
  if(!placaText && !file) return alert('Informe a placa (texto) ou envie uma foto.');
  qs('resSaida').innerHTML = 'Processando saída…';

  try{
    let placaFinal = placaText || null;

    // Se usuário deu apenas foto e não placa, não temos OCR aqui — pedir para digitar
    if(!placaFinal){
      return alert('Por favor digite a placa para registrar saída (quando usar apenas foto, digite a placa manualmente).');
    }

    // busca registro aberto mais recente da placa (sem saida)
    const q = await db.collection('registros')
      .where('placa','==',placaFinal)
      .where('saida','==',null)
      .orderBy('horarioEntrada','desc')
      .limit(1)
      .get();

    if(q.empty){
      return alert('Nenhuma entrada aberta encontrada para essa placa.');
    }

    const doc = q.docs[0];
    const data = doc.data();
    const horarioSaida = new Date().toISOString();
    const tempo = calcularTempo(data.horarioEntrada, horarioSaida);

    let fotoSaidaURL = null;
    if(file){
      const nome = `fotos/${placaFinal}_saida_${Date.now()}`;
      const ref = storage.ref().child(nome);
      await ref.put(file);
      fotoSaidaURL = await ref.getDownloadURL();
    }

    await db.collection('registros').doc(doc.id).update({
      saida: horarioSaida,
      fotoSaida: fotoSaidaURL || null,
      tempo
    });

    qs('resSaida').innerHTML = `<span style="color:#e8ffd8">Saída registrada. Tempo: ${tempo}</span>`;
    qs('placaSaida').value = ''; qs('fotoSaida').value = '';
    await carregarUltimos();
  }catch(err){
    console.error(err);
    alert('Erro ao registrar saída: ' + (err.message||err));
    qs('resSaida').innerHTML = '';
  }
});

// Pesquisar placa (mostra registro mais recente)
qs('btnBusca').addEventListener('click', async ()=>{
  const placa = qs('placaBusca').value.trim().toUpperCase();
  const out = qs('resBusca');
  out.innerHTML = '';
  if(!placa) return alert('Digite a placa para pesquisar.');

  out.innerHTML = 'Pesquisando…';
  try{
    const q = await db.collection('registros')
      .where('placa','==',placa)
      .orderBy('horarioEntrada','desc')
      .limit(1)
      .get();

    if(q.empty){
      out.innerHTML = `<p>Nenhum registro encontrado para <b>${placa}</b>.</p>`;
      return;
    }

    const r = q.docs[0].data();
    let html = `<p><b>Placa:</b> ${r.placa || '[sem placa]'}</p>
                <p><b>Tipo:</b> ${r.tipo}</p>
                <p><b>Entrada:</b> ${formatLocal(r.horarioEntrada)}</p>
                <p><b>Saída:</b> ${ r.saida ? formatLocal(r.saida) : '<i>Não saiu</i>' }</p>
                <p><b>Tempo:</b> ${ r.tempo ? r.tempo : (r.saida ? calcularTempo(r.horarioEntrada, r.saida) : '<i>Em andamento</i>') }</p>`;

    if(r.fotoEntrada) html += `<div class="foto"><b>Foto entrada:</b><br><img src="${r.fotoEntrada}" alt="foto entrada"></div>`;
    if(r.fotoSaida)  html += `<div class="foto"><b>Foto saída:</b><br><img src="${r.fotoSaida}" alt="foto saída"></div>`;

    out.innerHTML = html;
  }catch(err){
    console.error(err);
    out.innerHTML = `<p>Erro na pesquisa: ${err.message||err}</p>`;
  }
});

/* inicializar lista e botões */
qs('btnRefresh').addEventListener('click', carregarUltimos);
document.addEventListener('DOMContentLoaded', ()=>{ carregarUltimos(); });

</script>
</body>
</html>